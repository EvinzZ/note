# kafka线上问题优化

## 1.如何防止消息丢失

发送方：ack是1或者-1/all可以防止消息丢失，如果要做到99%，ack设成all，把min.insync.replicas配置成分区备份数

消费方：把自动提交改为手动提交。

## 2.如何防止消息的重复消费

一条消息被消费者消费多次，如果为了消息的不重复消费，而把生产端的重试机制关闭、消费者的手动提交改成自动提交，这样反而会出现消息丢失，那么可以直接在防止消息丢失的手段上再加上消费消息是的幂等性保证，就能解决消息的重复消费问题。

幂等性如何保证：

mysql插入业务id作为主键，主键是唯一的，所以一次只能插入一条

使用redis或zk的分布式锁（主流方案）

## 3.如何做到顺序消费

发送方：在发送时将ack不能设置成0，关闭重试，使用同步发送，等到发送成功再发送下一条。确保消息是顺序发送的。

接收方：消息是发送到一个分区中，只能有一个消费组的消费者来接收消息。

因此，kafka的顺序消费会牺牲掉性能。

## 4.解决消息积压问题

消息积压会导致很多问题，比如磁盘被打满、生产端发消息导致kafka性能过慢，就容易出现服务雪崩，就需要有相应的手段

方案一：在一个消费者中启动多个线程，让多个消费者同时消费。

方案二：如果方案一还不够的话，这个时候可以启动多个消费者，多个消费者部署在不同的服务器上。

